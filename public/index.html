<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Persistent Peer-to-Peer Chat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background-color: #f2f2f2;
    }

    .chat-container {
      width: 90%;
      max-width: 500px;
      background-color: #ffffff;
      border-radius: 10px;
      box-shadow: 0px 0px 15px rgba(0, 0, 0, 0.2);
      padding: 15px;
      position: relative;
    }

    /* Username Display */
    .username-display {
      position: absolute;
      top: 10px;
      right: 15px;
      font-weight: bold;
      color: #0277bd;
      font-size: 14px;
    }

    #clients {
      margin-bottom: 10px;
      font-size: 14px;
      color: #666;
    }

    #chat {
      height: 300px;
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      overflow-y: auto;
      margin-bottom: 10px;
      scrollbar-width: thin;
      /* Firefox */
    }

    /* Custom Scrollbar */
    #chat::-webkit-scrollbar {
      width: 6px;
    }

    #chat::-webkit-scrollbar-thumb {
      background-color: #b0bec5;
      border-radius: 10px;
    }

    #chat::-webkit-scrollbar-thumb:hover {
      background-color: #78909c;
    }

    .message {
      margin: 5px 0;
      padding: 8px 12px;
      border-radius: 8px;
      max-width: 70%;
      display: inline-block;
      word-wrap: break-word;
    }

    .from-message {
      background-color: #e1f5fe;
      color: #0277bd;
      text-align: left;
      float: left;
      clear: both;
    }

    .sent-message {
      background-color: #c8e6c9;
      color: #2e7d32;
      text-align: right;
      float: right;
      clear: both;
    }

    .input-container {
      display: flex;
      align-items: center;
    }

    #message {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      margin-right: 5px;
      outline: none;
    }

    #message:focus {
      border-color: #0277bd;
    }

    /* Button and Highlighted Client Button */
    button {
      padding: 10px 15px;
      font-size: 16px;
      background-color: #0277bd;
      color: #ffffff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      outline: none;
      transition: background-color 0.2s ease;
      margin-top: 5px;
    }

    button:hover {
      background-color: #01579b;
    }

    .client-button.selected {
      background-color: #041f13;
    }

    @media (max-width: 600px) {
      .chat-container {
        width: 100%;
        margin: 0;
        border-radius: 0;
      }

      #chat {
        height: 200px;
      }
    }
  </style>
</head>

<body>
  <div class="chat-container">
    <h2>Persistent Peer-to-Peer Chat</h2>
    <div class="username-display" id="usernameDisplay"></div> <!-- Username display in the top-right -->
    <div id="clients"><strong>Available clients:</strong></div>
    <div id="chat"></div>
    <div class="input-container">
      <input type="text" id="message" placeholder="Type a message..." onkeypress="handleKeyPress(event)">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script>
    let clientId;
    let username = localStorage.getItem("username"); // Retrieve the saved username
    let selectedClient;
    const ws = new WebSocket(`wss://${window.location.host}`);
    const chatBox = document.getElementById("chat");
    const clientsDiv = document.getElementById("clients");
    const usernameDisplay = document.getElementById("usernameDisplay");

    if (!username) {
      // Ask for username if it doesn't exist
      username = prompt("Enter your name:");
      localStorage.setItem("username", username); // Save it in local storage
    }

    usernameDisplay.textContent = `Logged in as: ${username}`; // Display username in top-right

    ws.onopen = () => {
      ws.send(JSON.stringify({ type: "join", username }));
    };

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);

      if (data.type === "id") {
        clientId = data.id;

      } else if (data.type === "clientList") {
        updateClientList(data.clients);

      } else if (data.type === "message") {
        // Store and display received message
        saveMessage(data.from, data.message, "from");
        if (data.from === selectedClient) {
          displayMessage(data.message, "from-message"); // No sender alias
        }
      }
    };

    function updateClientList(clients) {
      clientsDiv.innerHTML = "<strong>Online clients:</strong><br>";
      clients.forEach(client => {
        if (client.id !== clientId) {
          const clientBtn = document.createElement("button");
          clientBtn.className = "client-button";
          clientBtn.textContent = client.username;
          clientBtn.onclick = () => selectClient(client.id, client.username, clientBtn);
          clientsDiv.appendChild(clientBtn);
        }
      });
    }

    function selectClient(id, name, button) {
      selectedClient = name;
      chatBox.innerHTML = ""; // Clear chatBox for new chat
      loadChatHistory(name);

      // Highlight selected client button
      document.querySelectorAll(".client-button").forEach(btn => btn.classList.remove("selected"));
      button.classList.add("selected");
    }

    function sendMessage() {
      const input = document.getElementById("message");
      const message = input.value;

      if (message && selectedClient) {
        ws.send(JSON.stringify({ type: "message", to: selectedClient, message }));
        displayMessage(message, "sent-message"); // No "You:" prefix
        saveMessage(selectedClient, message, "sent");
        input.value = "";
      }
    }

    function displayMessage(message, cssClass) {
      const messageElement = document.createElement("div");
      messageElement.className = `message ${cssClass}`;
      messageElement.textContent = message; // Display message only
      chatBox.appendChild(messageElement);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function saveMessage(peerId, message, type) {
      // Retrieve the current chat history for the peer from local storage
      let chatHistory = JSON.parse(localStorage.getItem(peerId)) || [];
      // Add the new message to the chat history
      chatHistory.push({ type, message, timestamp: new Date().toISOString() });
      // Save the updated chat history back to local storage
      localStorage.setItem(peerId, JSON.stringify(chatHistory));
    }

    function loadChatHistory(peerId) {
      const chatHistory = JSON.parse(localStorage.getItem(peerId)) || [];

      chatHistory.forEach((chat) => {
        const cssClass = chat.type === "sent" ? "sent-message" : "from-message";
        displayMessage(chat.message, cssClass); // No sender alias
      });
    }

    function handleKeyPress(event) {
      if (event.key === "Enter") {
        sendMessage();
      }
    }
  </script>
</body>

</html>